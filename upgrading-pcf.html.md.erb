---
title: Upgrading Pivotal Cloud Foundry
owner: Ops Manager
---
 
<style>
    .note.warning {
        background-color: #fdd;
        border-color: #fbb
    }

    .note.warning:before {
        color: #f99;
     }
</style>
 
<strong><%= modified_date %></strong>

This topic describes upgrading PCF from version 1.6 to 1.7. The upgrade procedures below describe upgrading Ops Manager, Elastic Runtime, and any product tiles that you have installed for which 1.7 versions are available. 
     
If you have already upgraded your Ops Manager to version 1.7 and want to upgrade
individual products such as Pivotal Cloud Foundry&reg; Elastic Runtime, <a href="https://network.pivotal.io/products/p-mysql">Pivotal MySQL</a>, or <a
href="https://network.pivotal.io/products/pivotal-rabbitmq-service">RabbitMQ</a> in your PCF deployment, see the <a href="./upgrading-products.html">Upgrading
  Products in a PCF Deployment</a> topic.

<p class="note warning">
<strong>WARNING: </strong> Before you upgrade to Pivotal Cloud Foundry 1.7, you must migrate all apps that are currently running on DEA architecture to run on Diego architecture. All apps that do not already run on Diego will terminate during an upgrade from 1.6 to 1.7.
</p>


<p class="note warning">
<strong>WARNING: </strong> Pivotal Cloud Foundry 1.7 does not support PostgreSQL databases. During an upgrade from PCF version 1.6 to 1.7, data from the UAA and Cloud Controller Postgres databases automatically migrate to MySQL. This temporarily disables login through the UAA and SSO and may cause data loss if you have not prepared your databases. If your installation uses Postgres, review this page and see the <a href="./upgrading-products.html#aboutpostgres">About Postgres Databases During PCF Upgrade</a> section.
</p>


**Important**: Read the Known Issues section of the [Pivotal Cloud Foundry&reg;](https://network.pivotal.io/products/pivotal-cf) (PCF)
[Release Notes](../pcf-release-notes/index.html) before getting started.

## <a id="beforeupgrade"></a>Before You Upgrade

This section contains important guidelines that you must follow before beginning an upgrade to PCF 1.7. Failure to follow these instructions may jeopardize your existing deployment data or cause your upgrade to fail.

The tasks you need to complete before upgrade fall into three categories: 

+ [Prepare Your Environment](#prepare-env) — includes making sure you have sufficient disk space.
+ [Prepare Databases and Apps](#prepare-db) — includes backing up data and migrating any apps 
that currently use the DEA architecture to use the Diego architecture.  
+ [Check System Health](#check-health) — perform a health check of your system, from virtual machines (VMs) to service tiles. 

### <a id="prepare-env"></a>Prepare Your Environment for Upgrade

1. To upgrade your Pivotal Cloud Foundry&reg;</a> (PCF) installation to a target release, you must install the major releases from your currently deployed 
version to the target version in sequential order. For example, if your deployment uses Ops Manager release 1.5 and you are upgrading to 1.7, 
you must sequentially install 1.6 and 1.7.

    <p class="note"><strong>Note</strong>: Ensure that you are using Elastic Runtime (ERT) v. 1.6.9 or higher.</p>

2. Ensure that every product tile on the Installation Dashboard is compatible with the new version of Ops Manager. For specific compatibility information, refer to the full [Product Version  Matrix](../../compatibility-matrix.pdf).
If a product does not meet this requirement, you must upgrade the product or
remove the tile before upgrading Ops Manager.

3. For each product tile you have installed, review the upgrade documentation that is specific to the tile. For example, if you have RabbitMQ, you need to increase the number of HAproxy instances from one to two. See [RabbitMQ for Pivotal Cloud Foundry Upgrades](../../rabbitmq-cf/upgrade.html).

4. <%= partial 'check_disk_before_upgrade' %>

5. If you have disabled lifecycle errands  for any installed product in order to reduce deployment time, Pivotal recommends that you re-enable these errands before upgrading. See <a href="./add-delete.html#add-import">Adding and Deleting Products</a> for more  information.

6. Ensure that the VM resurrector is turned off:
   1. From your Installation Dashboard, select the **Ops Manager Director** tile. 
   2. Click **Director Config**.
   3. Clear the **Enable VM resurrector plugin** checkbox.


### <a id="prepare-db"></a>Prepare Databases and Apps for Upgrade


1. Back up all critical data prior to upgrading to PCF 1.7. Follow these instructions in the version 1.6 topic <a href="http://docs.pivotal.io/1.6/pivotalcf/customizing/backup-restore/backup-pcf.html">Backing Up Pivotal Cloud Foundry</a>. <br>
 

2. Before you upgrade to Pivotal Cloud Foundry 1.7, you must migrate all apps that are currently running on DEA architecture to run on Diego architecture. Pivotal does not support DEA architecture in Pivotal Cloud Foundry 1.7. See the [Migrating Apps to Diego](./apps-enable-diego.html) topic for information.

3. If you have Postgres databases, you must complete the following to prevent data loss:
      * Ensure you have enough disk space in by navigating to the **Resource Config** tab in **Elastic Runtime**. The MySQL Server must have at least as much persistent and ephemeral disk available as the Cloud Controller and UAA Postgres databases combined, to accommodate the data you are transferring.
      * Do not scale down Postgres databases to `0` before you upgrade to 1.7. 
    <p class="note"><strong>Note</strong>: The content of the Apps Manager database is not migrated during the upgrade. For this reason, you may experience some trivial data loss; for example if users have invitations to join PCF accounts in their inboxes, the invitation links might fail. </p>

<!-- 4. _outstanding question_ The GSS checklist discusses backing up and checking the status of MySQL. Do we need to add a cross-reference to database backup (MySQL and Postgres)? -->

### <a id="check-health"></a>Check System Health Before Upgrade

5. Run `bosh cloudcheck` to confirm that the VMs are healthy.  See the [BOSH Cloudcheck](../customizing/trouble-advanced.html#cck) topic.

6. Check the system health of installed products. In the Installation Dashboard, select the **Status** tab for each service tile. Confirm that all jobs are healthy.

7. (Optional) Check the logs for errors before proceeding with the upgrade.
See the [Viewing Logs in the Command Line Interface](../devguide/deploy-apps/streaming-logs.html#view) topic.  

8. There should be no outstanding changes in Ops Manager or any other tile. All tiles should be green.
Click **Apply Changes** if necessary.


## <a id="keep"></a>Upgrading with Installed Products ##

Follow the steps below to upgrade Ops Manager and keep all installed products.

<p class="note"><strong>Note</strong>: Ops Manager 1.7 uses the User Account and Authentication (UAA), instead of only local user account authentication. When you import your pre-1.7 file to Ops Manager, your user name changes to <code>admin</code> and your password remains the same. It also prompts you to create a shared passphrase, which is distinct from your password. Your passphrase on a new import will be the same as your password. However, you must change the passphrase for security purposes. </p>

1. From the Product Dashboard, select **Actions > Export installation
settings**.

    <%= image_tag("./images/upgrading/upgrade_to_1.7.png") %>

    This exports the current PCF installation with all of its assets.
    When you export an installation, the export contains the base VM images and
    necessary packages, and references to the installation IP addresses.
    As a result, an exported file can be very large, as much as 5 GB or more.
    * The export time depends on the size of the exported file.
    * Some browsers do not provide feedback on the status of the export
      process, and may appear to hang.
    * Some operating systems may automatically unzip the exported installation.
      If this occurs, create a zip file of the unzipped export.

    <p class="note"><strong>Note</strong>: When creating a zip file of an
      unzipped export, do not start compressing at the “installation” folder
      level.
      Instead, start compressing at the level containing the <code>config.yml</code> file:</p>

    <%= image_tag("./images/upgrading/compress.png") %>

2. Download the latest Ops Manager VM Template from the [Pivotal
Network](https://network.pivotal.io/products/pivotal-cf) site.

1. Record the IP address of the existing Ops Manager VM.

1. To avoid IP conflicts, power off the existing Ops Manager VM.

1. Deploy the new Ops Manager VM:
    * [Launching an Ops Manager Director Instance on AWS](./cloudform-om-deploy.html)
    * [Provisioning the OpenStack Infrastructure](./openstack-setup.html)
    * [Deploying Operations Manager to vSphere](./deploying-vm.html)
    * [Deploying Operations Manager to vCloud Air and vCloud](./pcf-vchs-vcloud.html)

1. When redirected to the **Welcome to Ops Manager** page, select **Import Existing Installation**. 

    <%= image_tag("./images/upgrading/welcome.png") %>

1. When prompted, enter the following:
  * **Decryption Passphrase**, which is the same as your password. 
  * Click **Choose File** and browse to the installation zip file exported in Step 3 above.

    <%= image_tag("./images/upgrading/decryption_passphrase.png") %>

1. Click **Import**.

    <p class="note"><strong>Note</strong>: 
      Some browsers do not provide feedback on the status of the import process,
      and may appear to hang.</p>

1. Before you see the new PCF 1.7 **Installation Dashboard**, a Security Features alert appears. Take note of your new **username**. Ensure you change your decryption passphrase before sharing it with other users. Click **Continue**.

    <%= image_tag("./images/upgrading/security_features.png") %>

1. A "Successfully imported installation" message appears upon completion.

    <%= image_tag("./images/upgrading/success.png") %>

1. Click **Apply Changes**. This immediately imports and applies upgrades to all tiles in a single transaction.

1. Click each service tile, select the **Status** tab, and confirm that all VMs appear and are in good health.

1. Remove the original Ops Manager VM from your IaaS if the new installation functions correctly.

## <a id="aftertheupgrade"></a>After the Upgrade

* If your 1.6 installation used Postgres databases, verify that the MySQL cluster is hosting a Cloud Controller Database and UAA Database. Retrieve the Postgres Postart logs from `/var/vcap/sys/log/postgres/poststart.std<err/out>.log`. You should see a confirmation message, `Finished migration from Postgres to MySQL` at the end of the stdout log. After successful migration, you can scale down the Postgres databases to `0` in the Resource Config tab in Elastic Runtime. 

* Advise your application developers on targeting Diego when pushing their applications. See [Diego Migration](./apps-enable-diego.html).

* (Optional) You can review your product tiles and configure values accordingly. For example, for Elastic Runtime, review the installation topic for new features:
     * [Launching an Ops Manager Director Instance on AWS](./cloudform-om-deploy.html)
     * [Provisioning the OpenStack Infrastructure](./openstack-setup.html)
     * [Deploying Operations Manager to vSphere](./deploying-vm.html)
     * [Deploying Operations Manager to vCloud Air and
       vCloud](./pcf-vchs-vcloud.html) 

